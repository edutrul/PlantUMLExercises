@startuml

/'
ğŸ›  Index Trigger Flow (CLI via Drush)

Scenario:
1. Admin runs the `$ drush fusion:export` command from the terminal.
2. Drupal re-indexes content using the Search API and builds the exportable data.
3. Drupal triggers a Fusion connector to ingest the content from the JSON endpoint.
4. Fusion fetches the data, starts the indexing job, and populates the Fusion Collection.

Requirements:
â€¢ Use actor for Admin.
â€¢ Use participants for Drush CLI, Drupal Search API, Drupal JSON Export, Fusion Connector, Indexing Pipeline, and Fusion Collection.
â€¢ Use `as` aliases for clarity.
â€¢ Use activation blocks to show processing time.
â€¢ Use notes to explain internal logic or optional conditions like partial updates.
â€¢ Style via `<style>` block (avoid deprecated `skinparam`).

Related diagrams:
 - ING-002 | SEQ-003 | Admin Manual Trigger via Drush (02-sequence-diagram--drush-trigger.puml)
 - ING-004 | SEQ-005 | Fusion UI â€œFetch Nowâ€ Trigger (04-sequence-diagram--restv2-fetch-now.puml)
'/

<style>
  title {
    FontSize 30
  }
  box {
    FontSize 25
    .drupalPlatform {
      BackgroundColor #F0F0F0ÃŸ
    }
    .fusionPlatform {
      BackgroundColor #E0F7F7
    }
    
  }
</style>

title 02 â€“ Admin Manual Trigger via Drush â€“ Lucidworks + Drupal Integration

autonumber
actor "Admin\n(with CLI access)" as AdminCLI
box "Drupal Platform" <<drupalPlatform>>
  participant DrushCLI [
    =ğŸ’» Drush CLI
    ----
    ""Custom Command""
  ]
  participant SearchAPI [
    =ğŸ“¦ Drupal Search API
    ----
    ""Indexer (Custom Module)""
  ]
  participant DrupalExport [
    =ğŸ”„ Drupal JSON Export
    ----
    ""/fusion-export/{$server}/{$index}""
  ]
end box

box "Fusion Platform" <<fusionPlatform>>
  participant FusionConnector [
    =ğŸ”§ Fusion Connector
    ----
    ""REST V2 or Custom""
  ]
  participant IndexingPipeline [
    =ğŸ“Š Fusion Indexing
    ----
    ""Pipeline""
  ]
  database "ğŸ—ƒï¸ Fusion Collection" as FusionCollection
end box

AdminCLI -> DrushCLI: Run **$ drush fusion:export**
note right of DrushCLI: Drush command triggers export\nlogic via Fusion Connector
activate DrushCLI
DrushCLI -> SearchAPI: Trigger internal Drupal re-index
deactivate DrushCLI

activate SearchAPI
note right of SearchAPI: Uses Drupal Search API\nframework to build data export
SearchAPI -> DrupalExport: Generate latest exportable dataÃŸ
note over of DrupalExport
  Acts as middleware between
  Drupal and Fusion Connector.
  Can be contributed or custom-built.
end note
deactivate SearchAPI

' âœ… Trigger Fusion *after* export is ready
DrushCLI -> FusionConnector: HTTP request to trigger external ingestion

activate FusionConnector
note right of FusionConnector
  Triggers crawl from JSON endpoint:
  â€¢ Full (REST V2)
  â€¢ *Partial (Custom Connector)
end note
FusionConnector -> DrupalExport: Fetch JSON export
activate DrupalExport
DrupalExport --> FusionConnector: Return content data
deactivate DrupalExport

FusionConnector -> IndexingPipeline: Start indexing job
deactivate FusionConnector

activate IndexingPipeline
IndexingPipeline -> FusionCollection: Ingest into Fusion Collection
deactivate IndexingPipeline

note bottom
  âš ï¸ *For partial updates, Lucidworks will call the JSON Export endpoint
  with a query parameter like **?since=timestamp**
  to limit the crawl to recently updated items.
end note

legend bottom
|= Component             |= Meaning |
| **Drupal Platform**    ||
| ğŸ–¥ï¸ Drush CLI           | Drupal CLI tool using custom Drush command |
| ğŸ“¦ Drupal Search API   | Custom indexing module |
| ğŸ”„ Drupal JSON Export  | Acts as middleware endpoint |
| **Fusion Platform**    ||
| ğŸ”§ Fusion Connector    | REST V2 or Custom connector to pull data |
| ğŸ§© Fusion Indexing     | Lucidworks pipeline to transform & ingest |
| ğŸ—ƒï¸ Fusion Collection   | Final Lucidworks index target |
endlegend

@enduml
